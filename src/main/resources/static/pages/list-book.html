<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Your neighbor personal library.">
        <meta name="keywords" content="library, give away book, book lending, book exchange, book swap, book swap app, book swap platforms, library app, nearby library, nearby books">
        <meta name="robots" content="index,follow">
        <meta name="googlebot" content="index,follow">
        
        <title>List a Book - BookBuddy</title>
        <link rel="icon" href="/images/bookbuddy_logo.png" type="image/png">

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/stylesheet.css">

        <!-- Leaflet for map -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    </head>
    
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
            <div class ="container-fluid ms-3">
                <a class="navbar-brand" href="/">
                    <img src="/images/bookbuddy_logo.png" alt="Logo" height="80">
                </a>
                <button class ="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navMenu">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="/pages/search-books.html">Search Books</a></li>
                        
                        <!-- auth required links -->
                        <li class="nav-item auth-required" style="display:none;"><a class="nav-link active" href="/pages/list-book.html">List a Book</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link" href="/pages/my-received-requests.html">My Received Requests</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link" href="/pages/my-sent-requests.html">My Sent Requests</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link" href="/pages/chat.html">Chat</a></li>
        
                    </ul>
                    
                    <!-- auth button-->
                    <div class="d-flex">
                        <div id="auth-buttons" class="auth-buttons">
                            <a href="/pages/login.html" class="btn btn-outline-primary me-2">Login</a>
                            <a href="/pages/register.html" class="btn btn-primary me-2">Sign Up</a>
                        </div>
                        
                        <!--user dropdown-->
                        <div id="user-menu" class="auth-required dropdown" style="display: none;">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="user-name">User</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/pages/profile.html"> üë§ My Profile</a></li>
                                <li><a class="dropdown-item" href="/pages/my-books.html">üìö My Books</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout" > üö™ Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>            
        </nav>
        
        <!-- PAGE CONTENT -->
        <div class="container mt-4 mb-5">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h4 class ="mb-0"> List a Book </h4>
                            <small>Share your books with the community</small>
                        </div>
                        <div class="card-body">
                            
                            <!-- alert msg -->
                            <div id="alertContainer"></div>
                            
                            <form id="listBookForm" action="/books/api/list" method="post">
                                
                                <!--book title-->
                                <div class="mb-3">
                                    <label for="title" class="form-label">Book Title *</label>
                                    <!-- form-control - Bootstrap class that styles the input with proper padding, borders, and focus states -->
                                    <input type="text" class="form-control" id="title" name="title" required
                                           placeholder="Enter the book title">
                                    <div class="invalid-feedback"></div><!--Bootstrap class for error messages (hidden by default, shown when validation fails) -->
                                </div>
                                
                                <!--author-->
                                <div class="mb-3">
                                    <label for="author" class="form-label">Author *</label>
                                    <input type="text" class="form-control" id="author" name="author" required 
                                           placeholder="Enter the author's name">
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!--genre-->
                                <div class="mb-3">
                                    <label for="genre" class="form-label">Genre</label>
                                    <input type="text" class="form-control" id="genre" name="genre" 
                                           placeholder="e.g., Fiction, Mystery, Romance (optional)">
                                </div>
                                
                                <!--ISBN-->
                                <div class="mb-3">
                                    <label for="isbn" class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="isbn" name="isbn"
                                           placeholder="ISBN-10 or ISBN-13 (optional)">
                                </div>
                                
                                <!--BOOK CONDITION-->
                                <div class="mb-3">
                                    <label for="condition" class="form-label">Condition *</label>
                                    <select class="form-select" id="condition" name="condition" required>
                                        <option value="">Select condition</option>
                                        <option value="New">New</option>
                                        <option value="Like New">Like New</option>
                                        <option value="Good">Good</option>
                                        <option value="Fair">Fair</option>
                                        <option value="Poor">Poor</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <!--description-->
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"
                                              placeholder="Brief description of the book (optional)"></textarea>
                                </div>
                                
                                <!--sharing type section-->
                                <div class="mb-4">
                                    <h6 class="fw-bold text-dark">Sharing Type</h6>
                                    
                                    <div class="mb-3">
                                        <label for="sharingType" class="form-label">How would you like to share this book? *</label>
                                        <select class="form-select" id="sharingType" name="sharingType" required>
                                            
                                            <option value="">Select sharing type</option>
                                            <option value="GIVE_AWAY">Give Away</option>
                                            <option value="LEND">Lend for Specific Period</option>
                                            <option value="SWAP">Swap</option>
                                        </select>
                                        
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    
                                    <!-- lending duration(shown only for LEND type)-->
                                    <div class="mb-3" id="lendingDurationSection" style="display: none;">
                                        <label for="lendingDurationDays" class="form-label">Maximum Lending Period (days) *</label>
                                        <input type="number" class="form-control" id="lendingDurationDays" name="lendingDurationDays"
                                               placeholder="e.g., 14" min="1" max="365">
                                        <div class="form-text">How long can someone borrow this book?</div>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                
                                <!--location section-->
                                <div class="mb-4">
                                    <h6 class="fw-bold text-dark" >üìç Pickup Location *</h6>
                                    
                                    <!--location selection buttons-->
                                    <div class="mb-3">
                                        <label class="form-label">Choose your pickup location</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-outline-primary" id="getCurrentLocation">
                                                üìç Use My Current Location
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="selectOnMap">
                                                üó∫Ô∏è Select on Map
                                            </button>
                                        </div>
                                        <div class="form-text">Select a location to help others find your book nearby. This is required for listing your book.</div>
                                    </div>
                                    
                                    <!--selected address display-->
                                    <div class="mb-3" id="addressDisplaySection" style="display: none;">
                                        <label for="pickupLocation" class="form-label">Selected Address</label>
                                        <input type="text" class="form-control" id="pickupLocation" name="pickupLocation"
                                               placeholder="Address will appear here after selecting location" readonly>
                                        <div class="form-text">This is the human-readable address for your selected location</div>
                                    </div>
                                    
                                    <!--hidden coordinate inputs--> 
                                    <input type="hidden" id="latitude" name="latitude">
                                    <input type="hidden" id="longitude" name="longitude">
                                    
                                    <!--location status--> 
                                    <div id="locationStatus" class="small text-muted"></div>
                                    
                                    <!--map container(hidden by default) -->
                                    <div id="mapContainer" style="display: none;">
                                        <div id="map" style="height: 300px; margin-top: 15px;" class="border rounded"></div>
                                        <div class="form-text mt-2">Click on the map to set pickup location</div>
                                    </div>
                                </div>

                                <!--submit button-->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                        üìö List My Book
                                    </button>
                                </div>

                                <div class="text-center mt-3">
                                    <small class="text-muted">* Required fields</small>
                                </div>
                                
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Leaflet for map location-->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        
        <script>
        //global variables
        let map = null; // hold the map object
        let marker = null; //hold a map pin/maker
        let userLocation = null; //for store user's GPS coordinates
        
        // Check authentication and setup page
        // addEventListener('when this happens', doThis(methods)
        document.addEventListener('DOMContentLoaded', function(){ //waits HTML page fully load b4 running the code inside
            checkAuthentication();
            setupFormHandling(); // set up for form submission logic
            setupLocationFeatures(); // set up map location features
            setupSharingTypeFeatures(); // set up sharing type features
            
            // check if the URL has special paramaters like: 
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success'); //bookbuddy.com/list-book?success=true
            const error = urlParams.get('error'); //bookbuddy.com/list-book?error=Something%20went%20wrong
            
            if(success){
                showAlert('success','This book has been listed successfully.');
            }
            if(error){
                showAlert('danger','Error: ' + decodeURIComponent(error));
            }
        });  //  ) for doc.addEventListener
        
        // authentication check
        function checkAuthentication(){
            fetch('/api/current-user', {credentials: 'include'})//tell the browser to send cookies(session tokens)w the request for authentication
                    .then(response => response.json()) // convert server response to JSON 
                    .then(data => {  // then(parameter=data) data contains the user info
                        if (data.authenticated){
                            // finds ALL elements on the page that match a CSS selector: auth-required
                            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'block'); //elements with class auth-required become visible
                            document.getElementById('auth-buttons').style.display = 'none'; // hide auth-buttons("Login", "Sign Up") 
                            document.getElementById('user-menu').style.display = 'block'; //show user menu
                            document.getElementById('user-name').innerText = data.firstName || "User"; //show user first name or "User" as fallback
                            
                        } else {
                            //redirect to login if not authentcated
                            window.location.href = '/pages/login.html';
                        }
            })  // )for .then data
            .catch(error => {
                    console.error('Auth check failed: ' + error); //logs the error if any failed issues
                    window.location.href = '/pages/login.html';
            }); // catch error
        }
        
        // form submission handling for book listing form(what it suppose to behave
        // including: block double click, check if book has set pick-up location(lad.long)
        // including:call API endpoint, then message(success or fail)
        function setupFormHandling(){
            
            const form = document.getElementById('listBookForm');
            const submitBtn = document.getElementById('submitBtn');
            
            // addEventListener('when this happens', doThis(methods)
            form.addEventListener('submit',function(e){
                
                //AJAX form=>stop normal form submission(Xpage reload)so tht JS code takes ctrl,handle submission wth fetch() in the background)
                e.preventDefault(); //user clicks Submit‚ÜíSuccess/error message appears‚ÜíStay on same page
                
                // reset validation to clear any previous error msg
                clearValidation();
                
                // show loading
                submitBtn.disabled = true; //disable submit button(prevet double-clickin)
                
                // Check if location is selected
                const latitude = document.getElementById('latitude').value;
                const longitude = document.getElementById('longitude').value;
                
                if (!latitude || !longitude){
                    showAlert('warning', 'Please select a pickup location using one of the location buttons.');
                    submitBtn.disabled = false;
                    return;
                }
                
                // Call submitForm function
                submitForm();
                
                function submitForm(){
                    // prepare form data as URL-encoded string
                    const formData = new URLSearchParams();
                    const formElements = form.elements;
                    for (let i = 0; i < formElements.length; i++) {//goes through each input/field in the form
                        const element = formElements[i];
                        if (element.name && element.value){
                            formData.append(element.name, element.value);//add the name & value to a URLSearchParams object
                        }
                    }
                    
                    // submit form
                    fetch('/books/api/list',{
                        method: 'POST',
                        headers: { //Headers:tells the server the data is URL-encoded
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData.toString()//body: the actual form data
                    })
                    
                    //response handling
                    //if server redirects(success case),follow the redirect.Otherwise,parse JSON response
                    .then(response => {
                        if (response.redirected){
                            window.location.href = response.url;
                            return;
                        }
                        return response.json();
                    })
                    
                    // success/error handling
                    .then(data =>{
                        if (data && data.success === false){
                            showAlert ('danger', data.message || "Failed to list book. Please try again.");
                            
                            // show field-specific errors if available
                            if (data.errors){
                                Object.keys(data.errors).forEach(field =>{
                                    showFieldError(field, data.errors[field]);
                                });
                            }
                        } else {
                            // success - will be handled by redirect
                            showAlert('success', 'Book listed successfully!');
                            form.reset();
                            clearLocation();
                        }
                                
                    })
                    
                    // if error
                    .catch( error => {
                        console.error('Error: ', error);
                        showAlert('danger','An error occurred. Please try again.');
                    })
                    
                    //cleanup, always run(success/fail) to re-enable submit btn
                    .finally(() => {
                        submitBtn.disabled = false;
                    });
                }
            });
        }
        
        // location features(share location or select frm map) how to trigger them to work
        function setupLocationFeatures(){
            document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);//triger the getCurrentLocation()
            document.getElementById('selectOnMap').addEventListener('click', toggleMap);//trigger to show the map after clicks selectOnMap icon
        }
        
        // book sharing type features: handle to ask for lend duration for lend option
        function setupSharingTypeFeatures(){
            const sharingTypeSelect = document.getElementById('sharingType');
            const lendingDurationSection = document.getElementById('lendingDurationSection');
            const lendingDurationInput = document.getElementById('lendingDurationDays');
            
            //event listener'change'=whenever the user changes the selected option,run the code inside the function
            sharingTypeSelect.addEventListener('change', function(){
                if (this.value === 'LEND'){
                    lendingDurationSection.style.display = 'block';
                    lendingDurationInput.required = true;
                } else {
                    lendingDurationSection.style.display = 'none';
                    lendingDurationInput.required = false;
                    lendingDurationInput.value = '';
                }
            });
        }

        // ASK FOR CURRECT LOCATION FEATURE
        function getCurrentLocation(){
            if (!navigator.geolocation){//checks whether the user's browser supports geolocation
                showAlert('warning', 'Geolocation is not supported by this browser.');
                return;
            }

            const btn = document.getElementById('getCurrentLocation');
            btn.disabled = true;//to prevent multiple clicks
            btn.innerHTML = 'üìç Getting your location...';//visual cue only tht lets user knows we're getting yr location

            navigator.geolocation.getCurrentPosition(
                function(position){
                    //coords=a¬†property¬†f the object tht the browser gives u when u get the user's location
                    //coords:holds all the geographic data
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    setLocation(lat, lng);

                    // get human-readable address from coordinates
                    reverseGeocode(lat, lng);

                    btn.disabled = false; //re-enable button
                    btn.innerHTML = 'üìç Use My Current Location';

                    updateLocationStatus(`Location set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                    showAlert('success', 'Location set successfully! Address will appear below.');
                },
                function(error){
                    let errorMsg = 'Unable to get location. ';
                    switch(error.code){
                        
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Location access denied.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;                         
                    }

                    showAlert('warning', errorMsg);

                    btn.disabled = false; //re-enable the button
                    btn.innerHTML = 'üìç Use My Current Location'; //resets its label
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        }

        //SELECT ON MAP FEATURE
        //shows or hides the map
        function toggleMap(){
            const mapContainer = document.getElementById('mapContainer');

            if (mapContainer.style.display === 'none') {
                mapContainer.style.display = 'block';
                initialiseMap();
            } else {
                mapContainer.style.display = 'none';
            }
        }

        //including:create Leaftlet map,load OpenStreetMap tiles,click handler(get coordinate)
        function initialiseMap(){
            if (map) {
                map.remove();
            }

            //set default location to Dublin coordinates
            const defaultLat = 53.3498;
            const defaultLng = -6.2603;

            //create a new Leaflet map inside the HTML element with ID "map"
            //syntax: setView([lat, lng], zoomLevel)
            map = L.map('map').setView([defaultLat, defaultLng], 13);

            //tileLayer adds the visual background map tiles from OpenStreetMap
            //if not,map will be just a gray box,no streets, cities, background
            //Leaflet only gives the map container & controls,no actual visual map.
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add click handler
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                setLocation(lat, lng);//saves & updates the coordinates
                addMapMarker(lat, lng);//shows a marker at the clicked spot
                reverseGeocode(lat, lng);
                showAlert('success', 'Location selected! Address will appear below.');
            });

            // If we already have a location, show it
            const currentLat = document.getElementById('latitude').value;
            const currentLng = document.getElementById('longitude').value;

            if (currentLat && currentLng) { //if latitude and longitude values exist:
                //html form inputs are String,so neeed to parse from string->numbers with parseFloat()
                addMapMarker(parseFloat(currentLat), parseFloat(currentLng));//eg:convert "53.3498"(string)‚Üí53.3498(number)
                map.setView([currentLat, currentLng], 15);
            }
        }

        //to mark the spot(a pin/icon)
        function addMapMarker(lat, lng) {
            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker([lat, lng]).addTo(map);
        }

        //store the location. works for BOTH WAY(share location, select on map)
        function setLocation(lat, lng) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            userLocation = {lat, lng};
            
            // Show the address display section
            document.getElementById('addressDisplaySection').style.display = 'block';
        }

        function clearLocation() {
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('pickupLocation').value = '';
            updateLocationStatus('');
            userLocation = null;
            
            // Hide the address display section
            document.getElementById('addressDisplaySection').style.display = 'none';

            if (marker && map) {
                map.removeLayer(marker);
                marker = null;
            }
        }

        //Converts coordinates into a human-readable address
        function reverseGeocode(lat, lng) {
           // simple reverse geocoding using Nominatim
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        document.getElementById('pickupLocation').value = data.display_name;
                    }
                })
                .catch(error => {
                    console.warn('Reverse geocoding failed:', error);
                });
        }



        function updateLocationStatus(message) {
            document.getElementById('locationStatus').textContent = message;
        }

        //utility functions
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            alertContainer.appendChild(alertDiv);

            // Auto-hide success alerts after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            if (field) {
                field.classList.add('is-invalid');
                const feedback = field.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = message;
                }
            }
        }

        function clearValidation() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        }
        </script>

        <!-- Footer -->
        <section class="bg-light text-dark">
            <div class="container mt-3">
              <div class="row g-4 justify-content-center">
                
                <!-- Follow us centered in full width -->
                <div class="col-12 text-center mb-5">
                  <h5 class="category-heading">Follow us</h5>
                  <div class="d-flex justify-content-center gap-4">
                    <a href="https://www.facebook.com/NCIRL/" class="fuIcon">
                      <img src="/images/icons8-facebook-128.png" alt="facebook icon">
                    </a>
                    <a href="https://www.instagram.com/ncirl/" class="fuIcon">
                      <img src="/images/icons8-instagram-160.png" alt="instagram icon">
                    </a>
                    <a href="https://x.com/NCIRL" class="fuIcon">
                      <img src="/images/icons8-twitterx-144.png" alt="twitter icon">
                    </a>
                  </div>
                </div>
          
              </div>
              <div class="col-12 mt-2 pb-2 text-center text-light">
                &copy; 2025, BookBuddy
              </div>
            </div>
        </section>
</body>
</html>