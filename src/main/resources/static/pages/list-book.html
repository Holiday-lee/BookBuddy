<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List a Book - BookBuddy</title>
    <link rel="icon" href="/images/bookbuddy_logo.png" type="image/png">
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/stylesheet.css">
    
    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container-fluid ms-3">
        <a class="navbar-brand" href="/">
            <img src="/images/bookbuddy_logo.png" alt="Logo" height="80">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navMenu">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/pages/search-books.html">Search Books</a></li>
                
                <!-- Auth-required links -->
                <li class="nav-item auth-required" style="display: none;"><a class="nav-link active" href="/pages/list-book.html">List a Book</a></li>
                <li class="nav-item auth-required" style="display: none;"><a class="nav-link" href="/pages/my-received-requests.html">My Received Requests</a></li>
                <li class="nav-item auth-required" style="display: none;"><a class="nav-link" href="/pages/my-sent-requests.html">My Sent Requests</a></li>
                <li class="nav-item auth-required" style="display: none;"><a class="nav-link" href="/pages/chat.html">Chat</a></li>
                <li class="nav-item auth-required" style="display: none;"><a class="nav-link" href="/pages/swap-history.html">Swap History</a></li>
            </ul>

            <!-- Auth buttons -->
            <div class="d-flex">
                <div id="auth-buttons" class="auth-buttons">
                    <a href="/pages/login.html" class="btn btn-outline-primary me-2">Login</a>
                    <a href="/pages/register.html" class="btn btn-primary">Sign Up</a>
                </div>

                <!-- User dropdown -->
                <div id="user-menu" class="auth-required dropdown" style="display: none;">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <span id="user-name">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/pages/profile.html">üë§ My Profile</a></li>
                        <li><a class="dropdown-item" href="/pages/my-books.html">üìö My Books</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">üö™ Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìñ List a Book</h4>
                    <small>Share your books with the community</small>
                </div>
                <div class="card-body">
                    <!-- Alert Messages -->
                    <div id="alertContainer"></div>

                    <form id="listBookForm" action="/books/list" method="post">
                        <!-- Title -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Book Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required
                                   placeholder="Enter the book title">
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <!-- Author -->
                        <div class="mb-3">
                            <label for="author" class="form-label">Author *</label>
                            <input type="text" class="form-control" id="author" name="author" required
                                   placeholder="Enter the author's name">
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <!-- Genre -->
                        <div class="mb-3">
                            <label for="genre" class="form-label">Genre</label>
                            <input type="text" class="form-control" id="genre" name="genre"
                                   placeholder="e.g., Fiction, Mystery, Romance (optional)">
                        </div>
                        
                        <!-- ISBN -->
                        <div class="mb-3">
                            <label for="isbn" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="isbn" name="isbn"
                                   placeholder="ISBN-10 or ISBN-13 (optional)">
                        </div>
                        
                        <!-- Condition -->
                        <div class="mb-3">
                            <label for="condition" class="form-label">Condition *</label>
                            <select class="form-select" id="condition" name="condition" required>
                                <option value="">Select condition</option>
                                <option value="New">New</option>
                                <option value="Like New">Like New</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="Brief description of the book (optional)"></textarea>
                        </div>
                        
                        <!-- Location Section -->
                        <div class="mb-4">
                            <h6 class="fw-bold text-primary">üìç Pickup Location</h6>
                            
                            <!-- Location Input -->
                            <div class="mb-3">
                                <label for="pickupLocation" class="form-label">Address/Description</label>
                                <input type="text" class="form-control" id="pickupLocation" name="pickupLocation"
                                       placeholder="e.g., Central Library, Dublin City Centre">
                                <div class="form-text">Where can someone pick up this book?</div>
                            </div>
                            
                            <!-- Get Current Location Button -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="getCurrentLocation">
                                    üìç Use My Current Location
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="selectOnMap">
                                    üó∫Ô∏è Select on Map
                                </button>
                            </div>
                            
                            <!-- Hidden coordinate inputs -->
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                            
                            <!-- Location status -->
                            <div id="locationStatus" class="small text-muted"></div>
                            
                            <!-- Map container (hidden by default) -->
                            <div id="mapContainer" style="display: none;">
                                <div id="map" style="height: 300px; margin-top: 15px;" class="border rounded"></div>
                                <div class="form-text mt-2">Click on the map to set pickup location</div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                                üìö List My Book
                            </button>
                        </div>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">* Required fields</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Global variables
let map = null;
let marker = null;
let userLocation = null;

// Check authentication and setup page
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    setupFormHandling();
    setupLocationFeatures();
    
    // Check for flash messages in URL params
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get('success');
    const error = urlParams.get('error');
    
    if (success) {
        showAlert('success', 'Success! Your book has been listed successfully.');
    }
    if (error) {
        showAlert('danger', 'Error: ' + decodeURIComponent(error));
    }
});

// Authentication check
function checkAuthentication() {
    fetch('/api/current-user')
        .then(response => response.json())
        .then(data => {
            if (data.authenticated) {
                document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'block');
                document.getElementById('auth-buttons').style.display = 'none';
                document.getElementById('user-menu').style.display = 'block';
                document.getElementById('user-name').innerText = data.firstName || "User";
            } else {
                // Redirect to login if not authenticated
                window.location.href = '/pages/login.html';
            }
        })
        .catch(error => {
            console.error('Auth check failed:', error);
            window.location.href = '/pages/login.html';
        });
}

// Form handling
function setupFormHandling() {
    const form = document.getElementById('listBookForm');
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Reset validation
        clearValidation();
        
        // Show loading
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        
        // Prepare form data
        const formData = new FormData(form);
        
        // Submit form
        fetch('/books/list', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success === false) {
                showAlert('danger', data.message || 'Failed to list book. Please try again.');
                
                // Show field-specific errors if available
                if (data.errors) {
                    Object.keys(data.errors).forEach(field => {
                        showFieldError(field, data.errors[field]);
                    });
                }
            } else {
                // Success - will be handled by redirect
                showAlert('success', 'Book listed successfully!');
                form.reset();
                clearLocation();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'An error occurred. Please try again.');
        })
        .finally(() => {
            submitBtn.disabled = false;
            spinner.classList.add('d-none');
        });
    });
}

// Location features
function setupLocationFeatures() {
    document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);
    document.getElementById('selectOnMap').addEventListener('click', toggleMap);
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        showAlert('warning', 'Geolocation is not supported by this browser.');
        return;
    }
    
    const btn = document.getElementById('getCurrentLocation');
    btn.disabled = true;
    btn.innerHTML = 'üìç Getting location...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            setLocation(lat, lng);
            
            // Try to get address from coordinates
            reverseGeocode(lat, lng);
            
            btn.disabled = false;
            btn.innerHTML = 'üìç Use My Current Location';
            
            updateLocationStatus(`Location set: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        },
        function(error) {
            let errorMsg = 'Unable to get location. ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg += 'Location access denied.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg += 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMsg += 'Location request timed out.';
                    break;
            }
            
            showAlert('warning', errorMsg);
            
            btn.disabled = false;
            btn.innerHTML = 'üìç Use My Current Location';
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutes
        }
    );
}

function toggleMap() {
    const mapContainer = document.getElementById('mapContainer');
    
    if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
        initializeMap();
    } else {
        mapContainer.style.display = 'none';
    }
}

function initializeMap() {
    if (map) {
        map.remove();
    }
    
    // Default to Dublin coordinates
    const defaultLat = 53.3498;
    const defaultLng = -6.2603;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add click handler
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        setLocation(lat, lng);
        addMapMarker(lat, lng);
        reverseGeocode(lat, lng);
    });
    
    // If we already have a location, show it
    const currentLat = document.getElementById('latitude').value;
    const currentLng = document.getElementById('longitude').value;
    
    if (currentLat && currentLng) {
        addMapMarker(parseFloat(currentLat), parseFloat(currentLng));
        map.setView([currentLat, currentLng], 15);
    }
}

function addMapMarker(lat, lng) {
    if (marker) {
        map.removeLayer(marker);
    }
    
    marker = L.marker([lat, lng]).addTo(map);
}

function setLocation(lat, lng) {
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    userLocation = {lat, lng};
}

function clearLocation() {
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    document.getElementById('pickupLocation').value = '';
    updateLocationStatus('');
    userLocation = null;
    
    if (marker && map) {
        map.removeLayer(marker);
        marker = null;
    }
}

function reverseGeocode(lat, lng) {
    // Simple reverse geocoding using Nominatim
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`)
        .then(response => response.json())
        .then(data => {
            if (data && data.display_name) {
                document.getElementById('pickupLocation').value = data.display_name;
            }
        })
        .catch(error => {
            console.warn('Reverse geocoding failed:', error);
        });
}

function updateLocationStatus(message) {
    document.getElementById('locationStatus').textContent = message;
}

// Utility functions
function showAlert(type, message) {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    alertContainer.appendChild(alertDiv);
    
    // Auto-hide success alerts after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

function showFieldError(fieldName, message) {
    const field = document.getElementById(fieldName);
    if (field) {
        field.classList.add('is-invalid');
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        if (feedback) {
            feedback.textContent = message;
        }
    }
}

function clearValidation() {
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
}
</script>

</body>
</html>