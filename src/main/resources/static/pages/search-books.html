<!DOCTYPE html>
<html lang="en">
    <head>        
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Your neighbor personal library.">
        <meta name="keywords" content="library, give away book, book lending, book exchange, book swap, book swap app, book swap platforms, library app, nearby library, nearby books">
        <meta name="robots" content="index,follow">
        <meta name="googlebot" content="index,follow">

        
        <title>Search Books - BookBuddy</title>
        <link rel="icon" href="/images/bookbuddy_logo.png" type="image/png">

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
            <div class="container-fluid ms-3">
                <a class="navbar-brand" href="/">
                    <img src="/images/bookbuddy_logo.png" alt="Logo" height="80">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navMenu">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/pages/search-books.html">Search Books</a></li>
                        
                        <!-- Auth required links -->
                        <li class="nav-item auth-required" style="display:none;"><a class="nav-link" href="/pages/list-book.html">List a Book</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link position-relative" href="/pages/my-received-requests.html">My Received Requests<span id="received-requests-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.6em;">0</span></a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link position-relative" href="/pages/my-sent-requests.html">My Sent Requests<span id="sent-requests-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.6em;">0</span></a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link position-relative" href="/pages/chat.html">Chat<span id="chat-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.6em;">0</span></a></li>
        
                    </ul>
                    
                    <!-- Auth button-->
                    <div class="d-flex">
                        <div id="auth-buttons" class="auth-buttons">
                            <a href="/pages/login.html" class="btn btn-outline-primary me-2">Login</a>
                            <a href="/pages/register.html" class="btn btn-primary me-2">Sign Up</a>
                        </div>
                        
                        <!--User dropdown-->
                        <div id="user-menu" class="auth-required dropdown" style="display: none;">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="user-name">User</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/pages/profile.html"> üë§ My Profile</a></li>
                                <li><a class="dropdown-item" href="/pages/my-books.html">üìö My Books</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout" > üö™ Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>            
        </nav>
        
        <!-- PAGE CONTENT -->
        <div class="container mt-4 mb-5">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">Search Books</h4>
                            <small>Find books available for swap in your area</small>
                        </div>
                        <div class="card-body">
                            <!-- Search Form -->
                            <form id="searchForm" class="mb-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="searchQuery" class="form-label">Search</label>
                                        <input type="text" class="form-control" id="searchQuery" 
                                               placeholder="Search by title, author, or genre">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="sharingTypeFilter" class="form-label">Sharing Type</label>
                                        <select class="form-select" id="sharingTypeFilter">
                                            <option value="">Any type</option>
                                            <option value="GIVE_AWAY">Give Away</option>
                                            <option value="LEND">Lend</option>
                                            <option value="SWAP">Swap</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="radiusFilter" class="form-label">Radius (km)</label>
                                        <select class="form-select" id="radiusFilter">
                                            <option value="5">5 km</option>
                                            <option value="10">10 km</option>
                                            <option value="25">25 km</option>
                                            <option value="50">50 km</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            üîç Search Books
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" id="useMyLocation">
                                            üìç Use My Location
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- Results Section -->
                            <div id="searchResults">
                                <div class="text-center text-muted">
                                    <p>Search for books to find what's available in your area</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Request Modal -->
        <div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="requestModalLabel">Request Book</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="bookInfo" class="mb-3">
                            <!-- Book information will be populated here -->
                        </div>
                        <form id="requestForm">
                            <div class="mb-3">
                                <label for="requestMessage" class="form-label">Message (Optional)</label>
                                <textarea class="form-control" id="requestMessage" rows="3" 
                                          placeholder="Tell the owner why you're interested in this book..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="sendRequestBtn">Send Request</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Book Selection Modal for Swap -->
        <div class="modal fade" id="bookSelectionModal" tabindex="-1" aria-labelledby="bookSelectionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bookSelectionModalLabel">Select a Book to Offer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-3">Choose a book from your collection to offer in exchange:</p>
                        <div id="bookSelectionList" class="row g-3">
                            <!-- Books will be populated here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        
        <!-- Notifications Script -->
        <script src="/js/notifications.js"></script>
        
        <script>
        let userLocation = null;
        let currentBook = null;
        let currentBookSharingType = null;
        let currentBookData = null;
        let requestModal = null;
        
        document.addEventListener('DOMContentLoaded', function(){
            checkAuthentication();
            setupSearchForm();
            setupRequestModal();
        });
        
        function checkAuthentication(){
            console.log('Checking authentication...');
            fetch('/api/current-user', { credentials: 'include' })
                    .then(response => {
                        console.log('Auth check response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Auth check response data:', data);
                        
                        if (data.authenticated){
                            console.log('User is authenticated, showing authenticated UI');
                            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'block');
                            document.getElementById('auth-buttons').style.display = 'none';
                            document.getElementById('user-menu').style.display = 'block';
                            document.getElementById('user-name').innerText = data.firstName || "User";
                            
                            // Initialize notifications
                            if (window.notifications) {
                                window.notifications.initNotifications();
                            }
                        } else {
                            console.log('User is not authenticated, showing public UI');
                            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'none');
                            document.getElementById('auth-buttons').style.display = 'flex';
                            document.getElementById('user-menu').style.display = 'none';
                        }
            })
            .catch(error => {
                    console.error('Auth check failed: ' + error);
            });
        }
        
        function setupSearchForm() {
            const form = document.getElementById('searchForm');
            const useLocationBtn = document.getElementById('useMyLocation');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                performSearch();
            });
            
            useLocationBtn.addEventListener('click', function() {
                getCurrentLocation();
            });
        }
        
        function setupRequestModal() {
            requestModal = new bootstrap.Modal(document.getElementById('requestModal'));
            
            document.getElementById('sendRequestBtn').addEventListener('click', function() {
                sendRequest();
            });
        }
        
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }
            
            const btn = document.getElementById('useMyLocation');
            btn.disabled = true;
            btn.innerHTML = 'üìç Getting location...';
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Use My Location';
                    performSearch();
                },
                function(error) {
                    alert('Unable to get your location. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Use My Location';
                }
            );
        }
        
        function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const sharingType = document.getElementById('sharingTypeFilter').value;
            const radius = document.getElementById('radiusFilter').value;
            
            let url = '/books/api/search?q=' + encodeURIComponent(query);
            
            if (sharingType) {
                url += '&sharingType=' + encodeURIComponent(sharingType);
            }
            
            if (userLocation) {
                url += `&lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(books => {
                    // Handle both array response and object response
                    const bookList = Array.isArray(books) ? books : (books.books || []);
                    displayResults(bookList);
                })
                .catch(error => {
                    console.error('Search failed:', error);
                    document.getElementById('searchResults').innerHTML = 
                        '<div class="alert alert-danger">Failed to search books. Please try again.</div>';
                });
        }
        
        function displayResults(books) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (books.length === 0) {
                resultsContainer.innerHTML = '<div class="text-center text-muted"><p>No books found matching your criteria.</p></div>';
                return;
            }
            
            let html = '<div class="row g-3">';
            
            books.forEach(book => {
                const sharingTypeDisplay = book.sharingType ? book.sharingType.replace('_', ' ') : 'Unknown';
                const statusBadge = book.status === 'AVAILABLE' ? 
                    '<span class="badge bg-success">Available</span>' : 
                    '<span class="badge bg-secondary">' + book.status + '</span>';
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100" data-book-id="${book.id}" data-book-sharing-type="${book.sharingType || ''}" data-book-lending-duration="${book.lendingDurationDays || ''}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">${book.title}</h5>
                                    ${statusBadge}
                                </div>
                                <h6 class="card-subtitle mb-2 text-muted">${book.author}</h6>
                                ${book.genre ? `<p class="card-text"><small class="text-muted">Genre: ${book.genre}</small></p>` : ''}
                                <p class="card-text"><small class="text-muted">Condition: ${book.condition}</small></p>
                                <p class="card-text"><small class="text-muted">üìö ${sharingTypeDisplay}</small></p>
                                ${book.lendingDurationDays ? `<p class="card-text"><small class="text-muted">‚è±Ô∏è Max ${book.lendingDurationDays} days</small></p>` : ''}
                                ${book.displayLocation ? `<p class="card-text"><small class="text-muted">üìç ${book.displayLocation}</small></p>` : ''}
                                ${book.description ? `<p class="card-text">${book.description}</p>` : ''}
                                ${book.owner ? `<p class="card-text"><small class="text-muted">üë§ Owner: <a href="/pages/user-profile.html?id=${book.owner.id}" class="text-decoration-none">${book.owner.fullName}</a></small></p>` : ''}
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm" onclick="requestBook(${book.id}, event)" ${book.status !== 'AVAILABLE' ? 'disabled' : ''}>
                                    üìñ Request Book
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        }
        
        function requestBook(bookId, event) {
            console.log('Request book called for bookId:', bookId);
            
            // Skip authentication check for now and proceed directly
            console.log('Skipping authentication check, proceeding with request...');
            
            // Find the book data from the current search results
            const bookCard = event ? event.target.closest('.card') : document.querySelector(`[onclick*="requestBook(${bookId})"]`).closest('.card');
            
            // Get book data from individual data attributes
            const cardBookId = bookCard.dataset.bookId;
            const cardBookSharingType = bookCard.dataset.bookSharingType;
            const cardBookLendingDuration = bookCard.dataset.bookLendingDuration;
            
            // Create a simple book data object
            const bookData = {
                id: parseInt(cardBookId),
                sharingType: cardBookSharingType,
                lendingDurationDays: cardBookLendingDuration ? parseInt(cardBookLendingDuration) : null
            };
            
            const bookTitle = bookCard.querySelector('.card-title').textContent;
            const bookAuthor = bookCard.querySelector('.card-subtitle').textContent;
            
            // Get condition - look for the small element that contains "Condition:"
            const conditionElement = Array.from(bookCard.querySelectorAll('small')).find(el => el.textContent.includes('Condition:'));
            const bookCondition = conditionElement ? conditionElement.textContent.replace('Condition: ', '') : 'Unknown';
            
            // Get genre - look for the small element that contains "Genre:"
            const genreElement = Array.from(bookCard.querySelectorAll('small')).find(el => el.textContent.includes('Genre:'));
            const bookGenre = genreElement ? genreElement.textContent.replace('Genre: ', '') : '';
            
            // Get sharing type from the stored book data
            const bookSharingType = bookData.sharingType || 'Unknown';
            
            // Store the sharing type for later use
            currentBookSharingType = bookSharingType;
            currentBookData = bookData;
            
            // Populate modal with book information
            document.getElementById('bookInfo').innerHTML = `
                <div class="alert alert-info">
                    <h6><strong>Book Title:</strong> ${bookTitle}</h6>
                    <p class="mb-1"><strong>Author:</strong> ${bookAuthor}</p>
                    <p class="mb-1"><strong>Condition:</strong> ${bookCondition}</p>
                    ${bookGenre ? `<p class="mb-1"><strong>Genre:</strong> ${bookGenre}</p>` : ''}
                    <p class="mb-0"><strong>Type:</strong> ${bookSharingType}</p>
                </div>
            `;
            
            // Store current book ID
            currentBook = bookId;
            
            // Clear previous message
            document.getElementById('requestMessage').value = '';
            
            // Show modal
            requestModal.show();
        }
        
        function sendRequest() {
            if (!currentBook) {
                alert('No book selected');
                return;
            }
            
            const message = document.getElementById('requestMessage').value;
            const sendBtn = document.getElementById('sendRequestBtn');
            const originalText = sendBtn.innerHTML;
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'Sending...';
            
            // Check if user is authenticated before making the request
            fetch('/api/current-user', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (!data.authenticated) {
                        alert('Please login or signup to request books. You can create an account to start requesting books from other users.');
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = originalText;
                        return;
                    }
                    
                    // User is authenticated, proceed with request
                    sendAuthenticatedRequest(message, sendBtn, originalText);
                })
                .catch(error => {
                    console.error('Auth check failed:', error);
                    alert('Please login or signup to request books. You can create an account to start requesting books from other users.');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                });
        }
        
        function sendAuthenticatedRequest(message, sendBtn, originalText) {
            // Determine the appropriate endpoint based on sharing type
            let endpoint = '/requests/api/give-away';
            let requestBody = `bookId=${currentBook}&message=${encodeURIComponent(message)}`;
            
            if (currentBookSharingType === 'LEND') {
                // For lending, use the book's maximum lending duration or a default
                const maxDuration = currentBookData.lendingDurationDays || 30; // Default to 30 days if not specified
                endpoint = '/requests/api/lend';
                requestBody = `bookId=${currentBook}&message=${encodeURIComponent(message)}&requestedDurationDays=${maxDuration}`;
            } else if (currentBookSharingType === 'SWAP') {
                // For swap, we need to get the user's available books
                fetch('/books/api/swappable', {
                    method: 'GET',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(books => {
                    if (!Array.isArray(books) || books.length === 0) {
                        alert('Please list a book for swapping request');
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = originalText;
                        return;
                    }
                    
                    // Show book selection modal
                    showBookSelectionModal(books, message, sendBtn, originalText);
                })
                .catch(error => {
                    console.error('Failed to fetch swappable books:', error);
                    alert('Failed to load your books. Please try again.');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                });
                return; // Don't proceed with the regular request flow
            }
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'include',
                body: requestBody
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // Check if it's an authentication error
                    if (data.error === 'Not authenticated') {
                        alert('Please login or signup to request books. You can create an account to start requesting books from other users.');
                    } else {
                        alert('Error: ' + data.error);
                    }
                } else {
                    alert('Request sent successfully! The book owner will be notified.');
                    requestModal.hide();
                    // Refresh search results to show updated status
                    performSearch();
                }
            })
            .catch(error => {
                console.error('Request failed:', error);
                alert('Failed to send request. Please try again.');
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            });
        }

        // Global variables for book selection
        let bookSelectionModal = null;
        let selectedBookForSwap = null;
        let swapMessage = '';
        let swapSendBtn = null;
        let swapOriginalText = '';

        // Initialize book selection modal
        document.addEventListener('DOMContentLoaded', function() {
            bookSelectionModal = new bootstrap.Modal(document.getElementById('bookSelectionModal'));
        });

        function showBookSelectionModal(books, message, sendBtn, originalText) {
            // Store the swap context
            swapMessage = message;
            swapSendBtn = sendBtn;
            swapOriginalText = originalText;
            selectedBookForSwap = null;

            // Populate the book selection list
            const bookSelectionList = document.getElementById('bookSelectionList');
            let html = '';

            books.forEach(book => {
                const sharingTypeDisplay = book.sharingType ? book.sharingType.replace('_', ' ') : 'Unknown';
                
                html += `
                    <div class="col-md-6">
                        <div class="card h-100 book-selection-card" data-book-id="${book.id}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${book.title}</h6>
                                    <span class="badge bg-primary">${sharingTypeDisplay}</span>
                                </div>
                                <h6 class="card-subtitle mb-2 text-muted">${book.author}</h6>
                                ${book.genre ? `<p class="card-text"><small class="text-muted">Genre: ${book.genre}</small></p>` : ''}
                                <p class="card-text"><small class="text-muted">Condition: ${book.condition}</small></p>
                                ${book.description ? `<p class="card-text"><small class="text-muted">${book.description}</small></p>` : ''}
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="selectBookForSwap(${book.id})">
                                    Select This Book
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            bookSelectionList.innerHTML = html;

            // Show the modal
            bookSelectionModal.show();
        }

        function selectBookForSwap(bookId) {
            selectedBookForSwap = bookId;
            
            // Update UI to show selection
            document.querySelectorAll('.book-selection-card').forEach(card => {
                card.classList.remove('border-primary');
                const btn = card.querySelector('button');
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
                btn.textContent = 'Select This Book';
            });

            const selectedCard = document.querySelector(`[data-book-id="${bookId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('border-primary');
                const btn = selectedCard.querySelector('button');
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
                btn.textContent = '‚úì Selected';
            }

            // Send the swap request
            sendSwapRequest(bookId);
        }

        function sendSwapRequest(offeredBookId) {
            const endpoint = '/requests/api/swap';
            const requestBody = `bookId=${currentBook}&message=${encodeURIComponent(swapMessage)}&offeredBookId=${offeredBookId}`;

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                credentials: 'include',
                body: requestBody
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // Check if it's an authentication error
                    if (data.error === 'Not authenticated') {
                        alert('Please login or signup to request books. You can create an account to start requesting books from other users.');
                    } else {
                        alert('Error: ' + data.error);
                    }
                } else {
                    alert('Swap request sent successfully! The book owner will be notified.');
                    bookSelectionModal.hide();
                    requestModal.hide();
                    // Refresh search results to show updated status
                    performSearch();
                }
            })
            .catch(error => {
                console.error('Swap request failed:', error);
                alert('Failed to send swap request. Please try again.');
            })
            .finally(() => {
                if (swapSendBtn) {
                    swapSendBtn.disabled = false;
                    swapSendBtn.innerHTML = swapOriginalText;
                }
            });
        }
        </script>
    </body>
</html> 