<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - BookBuddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/stylesheet.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 100px);
            display: flex;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .chat-list-container {
            width: 350px;
            border-right: 1px solid #dee2e6;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        .chat-list-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background-color: #fff;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chat-item:hover {
            background-color: #e9ecef;
        }
        
        .chat-item.active {
            background-color: #007bff;
            color: white;
        }
        
        .chat-item.active .chat-preview,
        .chat-item.active .chat-book-title {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .chat-user-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .chat-user-details {
            flex: 1;
        }
        
        .chat-user-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .chat-book-title {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .chat-preview {
            font-size: 0.9em;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 0.8em;
            color: #adb5bd;
            margin-top: 5px;
        }
        
        .chat-conversation-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }
        
        .conversation-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background-color: #fff;
        }
        
        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.sent {
            justify-content: flex-end;
        }
        
        .message.received {
            justify-content: flex-start;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.sent .message-content {
            background-color: #007bff;
            color: white;
        }
        
        .message.received .message-content {
            background-color: #e9ecef;
            color: #212529;
        }
        
        .message-time {
            font-size: 0.75em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .message-input-container {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background-color: #fff;
        }
        
        .message-input-group {
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
        }
        
        .send-button {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-chat-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .typing-indicator {
            padding: 10px 15px;
            color: #6c757d;
            font-style: italic;
            font-size: 0.9em;
        }
        
        .unread-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            margin-left: auto;
        }
        
        .system-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin: 10px 0;
        }
        
        .no-chats {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }
        
        .no-chats i {
            font-size: 3em;
            margin-bottom: 20px;
            color: #dee2e6;
        }
        
        .loading-chats {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../images/bookbuddy_logo.png" alt="BookBuddy Logo" height="30">
                BookBuddy
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="search-books.html">Search Books</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="list-book.html">List Book</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my-books.html">My Books</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my-received-requests.html">Received Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my-sent-requests.html">Sent Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="chat.html">Chat</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="chat-container">
            <!-- Left Side - Chat List -->
            <div class="chat-list-container">
                <div class="chat-list-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-comments"></i> Conversations</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshChats()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-list" id="chatList">
                    <div class="loading-chats">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading conversations...</p>
                    </div>
                </div>
            </div>

            <!-- Right Side - Conversation -->
            <div class="chat-conversation-container">
                <div class="conversation-header" id="conversationHeader" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="chat-user-avatar" id="selectedChatAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0" id="selectedChatUserName">User Name</h6>
                            <small class="text-muted" id="selectedChatBookTitle">Book Title</small>
                        </div>
                    </div>
                </div>
                
                <div class="conversation-messages" id="conversationMessages">
                    <div class="no-chat-selected">
                        <div class="text-center">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Select a conversation to start chatting</p>
                        </div>
                    </div>
                </div>
                
                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="message-input-group">
                        <textarea class="form-control message-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                        <button class="btn btn-primary send-button" id="sendButton" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentUser = null;
        let chats = [];
        let selectedChatId = null;
        let stompClient = null;
        let typingTimer = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading state immediately
            document.getElementById('chatList').innerHTML = `
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p>Checking authentication...</p>
                </div>
            `;
            
            checkAuthentication();
        });

        function checkAuthentication() {
            fetch('/api/current-user', { credentials: 'include' })
                .then(response => {
                    console.log('Auth check response status:', response.status);
                    if (!response.ok) {
                        console.log('Auth check failed, redirecting to login');
                        // Use a more reliable redirect method
                        setTimeout(() => {
                            window.location.replace('login.html');
                        }, 100);
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Already handled redirect
                    
                    console.log('Auth check response data:', data);
                    if (!data.authenticated) {
                        console.log('User not authenticated, redirecting to login');
                        // Use a more reliable redirect method
                        setTimeout(() => {
                            window.location.replace('login.html');
                        }, 100);
                        return;
                    }
                    
                    currentUser = data;
                    console.log('User authenticated:', currentUser.email);
                    
                    // Add a small delay to ensure session is properly established
                    setTimeout(() => {
                        loadChats();
                    }, 100);
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    // Show a more user-friendly error message and provide manual redirect
                    document.getElementById('chatList').innerHTML = `
                        <div class="p-3 text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Authentication Error</p>
                            <small>Please log in to access the chat feature</small>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="window.location.replace('login.html')">
                                    <i class="fas fa-sign-in-alt"></i> Go to Login
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="window.location.reload()">
                                    <i class="fas fa-redo"></i> Retry
                                </button>
                            </div>
                        </div>
                    `;
                });
        }

        function loadChats() {
            console.log('Loading chats...');
            fetch('/api/chats', { credentials: 'include' })
                .then(response => {
                    console.log('Chats response status:', response.status);
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            console.log('Unauthorized access, redirecting to login');
                            // Use a more reliable redirect method
                            setTimeout(() => {
                                window.location.replace('login.html');
                            }, 100);
                            return;
                        }
                        throw new Error(`Failed to load chats: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Already handled redirect
                    
                    console.log('Chats data received:', data);
                    chats = data;
                    displayChatList();
                })
                .catch(error => {
                    console.error('Error loading chats:', error);
                    document.getElementById('chatList').innerHTML = `
                        <div class="p-3 text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Failed to load conversations</p>
                            <small>${error.message}</small>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="loadChats()">
                                    <i class="fas fa-redo"></i> Retry
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="window.location.replace('login.html')">
                                    <i class="fas fa-sign-in-alt"></i> Go to Login
                                </button>
                            </div>
                        </div>
                    `;
                });
        }

        function refreshChats() {
            loadChats();
        }

        function displayChatList() {
            const chatList = document.getElementById('chatList');
            
            if (!chats || chats.length === 0) {
                chatList.innerHTML = `
                    <div class="no-chats">
                        <i class="fas fa-comments"></i>
                        <h5>No Active Chats</h5>
                        <p>You don't have any active chats yet.</p>
                        <p>Start by accepting a book request to begin chatting!</p>
                        <a href="my-received-requests.html" class="btn btn-primary btn-sm">
                            <i class="fas fa-handshake"></i> View Received Requests
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            chats.forEach(chat => {
                const otherUser = chat.user1.id === currentUser.id ? chat.user2 : chat.user1;
                const book = chat.book;
                const lastMessage = chat.lastMessage;
                
                const lastMessageText = lastMessage ? lastMessage.content : 'No message yet';
                const lastMessageTime = lastMessage ? formatTime(lastMessage.createdAt) : '';
                
                // Get unread count for this chat (default to 0 if not available)
                const unreadCount = chat.unreadCount !== undefined ? chat.unreadCount : 0;
                
                html += `
                    <div class="chat-item" onclick="selectChat(${chat.id})" data-chat-id="${chat.id}">
                        <div class="chat-user-info">
                            <div class="chat-user-avatar">
                                ${otherUser.firstName.charAt(0).toUpperCase()}
                            </div>
                            <div class="chat-user-details">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="chat-user-name">${otherUser.firstName} ${otherUser.lastName}</div>
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                </div>
                                <div class="chat-book-title">ðŸ“š ${book.title}</div>
                                <div class="chat-preview">${lastMessageText}</div>
                                ${lastMessageTime ? `<div class="chat-time">${lastMessageTime}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            chatList.innerHTML = html;
        }

        function selectChat(chatId) {
            selectedChatId = chatId;
            
            // Update active state in chat list
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
            
            // Show conversation header and input
            document.getElementById('conversationHeader').style.display = 'block';
            document.getElementById('messageInputContainer').style.display = 'block';
            
            // Update header with chat info
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                const otherUser = chat.user1.id === currentUser.id ? chat.user2 : chat.user1;
                const book = chat.book;
                
                document.getElementById('selectedChatUserName').textContent = `${otherUser.firstName} ${otherUser.lastName}`;
                document.getElementById('selectedChatBookTitle').textContent = book.title;
                document.getElementById('selectedChatAvatar').innerHTML = otherUser.firstName.charAt(0).toUpperCase();
            }
            
            // Mark messages as read
            markMessagesAsRead(chatId);
            
            // Load messages for this chat
            loadMessages(chatId);
            
            // Connect to WebSocket for this chat
            connectWebSocket(chatId);
        }

        function loadMessages(chatId) {
            fetch(`/api/chats/${chatId}/messages`, { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }
                    return response.json();
                })
                .then(messages => {
                    displayMessages(messages);
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    document.getElementById('conversationMessages').innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Failed to load messages</p>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        function displayMessages(messages) {
            const messagesContainer = document.getElementById('conversationMessages');
            
            if (!messages || messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <p>No messages yet</p>
                        <small>Start the conversation!</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            messages.forEach(message => {
                const isSent = message.senderId === currentUser.id;
                const messageClass = isSent ? 'sent' : 'received';
                const messageTime = formatTime(message.createdAt);
                
                if (message.messageType === 'SYSTEM' || message.messageType === 'EXCHANGE_COMPLETED' || message.messageType === 'EXCHANGE_CANCELLED') {
                    html += `
                        <div class="system-message">
                            <small>${message.content}</small>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="message ${messageClass}">
                            <div class="message-content">
                                ${message.content}
                                <div class="message-time">${messageTime}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            messagesContainer.innerHTML = html;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !selectedChatId) return;
            
            fetch(`/api/chats/${selectedChatId}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({ content: content })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to send message');
                }
                return response.json();
            })
            .then(message => {
                messageInput.value = '';
                
                // Add message to the conversation
                const messagesContainer = document.getElementById('conversationMessages');
                const messageTime = formatTime(message.createdAt);
                
                const messageHtml = `
                    <div class="message sent">
                        <div class="message-content">
                            ${message.content}
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                `;
                
                // Remove "no messages" message if present
                const noMessages = messagesContainer.querySelector('.text-center.text-muted');
                if (noMessages) {
                    noMessages.remove();
                }
                
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Update chat list to show new message
                updateChatListWithNewMessage(selectedChatId, message);
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            });
        }

        function updateChatListWithNewMessage(chatId, message) {
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                chat.lastMessage = message;
                displayChatList();
                
                // Re-select the current chat to maintain active state
                if (selectedChatId === chatId) {
                    document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
                }
            }
        }

        function markMessagesAsRead(chatId) {
            fetch(`/api/chat/${chatId}/mark-read`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    // Update the chat list to remove the unread badge
                    const chat = chats.find(c => c.id === chatId);
                    if (chat) {
                        chat.unreadCount = 0;
                        displayChatList();
                        
                        // Re-select the current chat to maintain active state
                        if (selectedChatId === chatId) {
                            document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
                        }
                    }
                } else {
                    console.error('Failed to mark messages as read:', response.status);
                }
            })
            .catch(error => {
                console.error('Error marking messages as read:', error);
            });
        }
        
        function connectWebSocket(chatId) {
            if (stompClient) {
                stompClient.disconnect();
            }
            
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected to WebSocket');
                
                // Subscribe to chat messages
                stompClient.subscribe(`/topic/chat/${chatId}`, function(message) {
                    const messageData = JSON.parse(message.body);
                    handleIncomingMessage(messageData);
                });
                
                // Join the chat
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    chatId: chatId
                }));
            });
        }

        function handleIncomingMessage(messageData) {
            if (messageData.error) {
                console.error('WebSocket error:', messageData.error);
                return;
            }
            
            // Only add message if it's from the currently selected chat
            if (messageData.chatId === selectedChatId) {
                const messagesContainer = document.getElementById('conversationMessages');
                const messageTime = formatTime(messageData.createdAt);
                
                const messageHtml = `
                    <div class="message received">
                        <div class="message-content">
                            ${messageData.content}
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                `;
                
                // Remove "no messages" message if present
                const noMessages = messagesContainer.querySelector('.text-center.text-muted');
                if (noMessages) {
                    noMessages.remove();
                }
                
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Update chat list
                updateChatListWithNewMessage(selectedChatId, messageData);
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 24) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffInHours < 48) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString();
            }
        }

        // Event listeners
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function logout() {
            fetch('/logout', { 
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                window.location.href = 'login.html';
            })
            .catch(error => {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html> 