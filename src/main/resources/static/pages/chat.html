<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat - BookBuddy</title>
        <link rel="icon" href="/images/bookbuddy_logo.png" type="image/png">

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/stylesheet.css">
        
        <style>
            .chat-container {
                height: 70vh;
                overflow-y: auto;
                border: 1px solid #dee2e6;
                border-radius: 0.375rem;
                background-color: #f8f9fa;
            }
            
            .message {
                margin: 10px;
                padding: 10px;
                border-radius: 10px;
                max-width: 70%;
                word-wrap: break-word;
                position: relative;
            }
            
            .message.sent {
                background-color: #007bff;
                color: white;
                margin-left: auto;
            }
            
            .message.received {
                background-color: #e9ecef;
                color: #212529;
            }
            
            .message.system {
                background-color: #ffc107;
                color: #212529;
                text-align: center;
                max-width: 100%;
                font-style: italic;
            }
            
            .message-time {
                font-size: 0.75rem;
                opacity: 0.7;
                margin-top: 5px;
            }
            
            .message-sender {
                font-size: 0.8rem;
                font-weight: bold;
                margin-bottom: 2px;
            }
            
            .chat-input-container {
                border-top: 1px solid #dee2e6;
                padding: 15px;
                background-color: white;
            }
            
            .typing-indicator {
                padding: 10px;
                font-style: italic;
                color: #6c757d;
                font-size: 0.9rem;
            }
            
            .message-status {
                font-size: 0.7rem;
                opacity: 0.6;
                margin-top: 2px;
            }
            
            .chat-header-info {
                background-color: rgba(255, 255, 255, 0.1);
                padding: 8px;
                border-radius: 4px;
                margin-top: 8px;
            }
        </style>
    </head>
    
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
            <div class="container-fluid ms-3">
                <a class="navbar-brand" href="/">
                    <img src="/images/bookbuddy_logo.png" alt="Logo" height="80">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navMenu">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="/pages/search-books.html">Search Books</a></li>
                        
                        <!-- Auth required links -->
                        <li class="nav-item auth-required" style="display:none;"><a class="nav-link" href="/pages/list-book.html">List a Book</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link" href="/pages/my-received-requests.html">My Received Requests</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link" href="/pages/my-sent-requests.html">My Sent Requests</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link active" href="/pages/chat.html">Chat</a></li>
                        <li class="nav-item auth-required" style="display:none;" ><a class="nav-link" href="/pages/swap-history.html">Swap History</a></li>
                    </ul>
                    
                    <!-- Auth button-->
                    <div class="d-flex">
                        <div id="auth-buttons" class="auth-buttons">
                            <a href="/pages/login.html" class="btn btn-outline-primary me-2">Login</a>
                            <a href="/pages/register.html" class="btn btn-primary me-2">Sign Up</a>
                        </div>
                        
                        <!--User dropdown-->
                        <div id="user-menu" class="auth-required dropdown" style="display: none;">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="user-name">User</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/pages/profile.html"> üë§ My Profile</a></li>
                                <li><a class="dropdown-item" href="/pages/my-books.html">üìö My Books</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout" > üö™ Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>            
        </nav>
        
        <!-- PAGE CONTENT -->
        <div class="container mt-4 mb-5">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">üí¨ Chat with <span id="otherUserName">...</span></h4>
                            <small id="chatInfo">Loading chat information...</small>
                            <div id="bookInfo" class="mt-2" style="display: none;">
                                <small class="text-light">
                                    <strong id="bookTitle"></strong> by <span id="bookAuthor"></span>
                                    <br>
                                    <span id="bookDetails"></span>
                                </small>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="chatContainer" class="chat-container">
                                <div class="text-center p-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading chat...</p>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="messageInput" 
                                           placeholder="Type your message..." disabled>
                                    <button class="btn btn-primary" type="button" id="sendButton" disabled>
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="connectionStatus">Connecting...</small>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="completeExchange()" id="completeBtn" style="display: none;">
                                        ‚úÖ Complete Exchange
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="cancelExchange()" id="cancelBtn" style="display: none;">
                                        ‚ùå Cancel Exchange
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        
        <!-- SockJS and STOMP -->
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        
        <script>
        let stompClient = null;
        let currentChatId = null;
        let currentUserId = null;
        let chatInfo = null;
        let typingTimer = null;
        let isTyping = false;
        let otherUserName = null;
        
        document.addEventListener('DOMContentLoaded', function(){
            checkAuthentication();
            setupChat();
        });
        
        function checkAuthentication(){
            fetch('/api/current-user', { credentials: 'include' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.authenticated){
                            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'block');
                            document.getElementById('auth-buttons').style.display = 'none';
                            document.getElementById('user-menu').style.display = 'block';
                            document.getElementById('user-name').innerText = data.firstName || "User";
                            currentUserId = data.id;
                        } else {
                            document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'none');
                            document.getElementById('auth-buttons').style.display = 'flex';
                            document.getElementById('user-menu').style.display = 'none';
                        }
            })
            .catch(error => {
                    console.error('Auth check failed: ' + error);
            });
        }
        
        function setupChat() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('requestId');
            
            if (!requestId) {
                document.getElementById('chatContainer').innerHTML = 
                    '<div class="alert alert-danger m-3">No request ID provided</div>';
                return;
            }
            
            // Get enhanced chat information
            fetch(`/api/chat/request/${requestId}/details`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('chatContainer').innerHTML = 
                            `<div class="alert alert-danger m-3">${data.error}</div>`;
                        return;
                    }
                    
                    const chat = data.chat;
                    const book = data.book;
                    const user1 = data.user1;
                    const user2 = data.user2;
                    const currentUserId = data.currentUserId;
                    
                    currentChatId = chat.id;
                    chatInfo = chat;
                    
                    // Update chat info with book details
                    document.getElementById('chatInfo').innerText = `Chat for "${book.title}"`;
                    
                    // Display book information
                    document.getElementById('bookTitle').innerText = book.title;
                    document.getElementById('bookAuthor').innerText = book.author;
                    
                    let bookDetails = [];
                    if (book.genre) bookDetails.push(book.genre);
                    if (book.condition) bookDetails.push(`Condition: ${book.condition}`);
                    if (book.sharingType) bookDetails.push(`Type: ${book.sharingType}`);
                    
                    document.getElementById('bookDetails').innerText = bookDetails.join(' ‚Ä¢ ');
                    document.getElementById('bookInfo').style.display = 'block';
                    
                    // Determine other user name
                    const otherUser = (user1.id === currentUserId) ? user2 : user1;
                    otherUserName = `${otherUser.firstName} ${otherUser.lastName}`;
                    
                    // Update page title
                    document.title = `Chat with ${otherUserName} - BookBuddy`;
                    document.getElementById('otherUserName').innerText = otherUserName;
                    
                    // Load messages
                    loadMessages();
                    
                    // Connect to WebSocket
                    connectWebSocket();
                    
                    // Show action buttons
                    document.getElementById('completeBtn').style.display = 'inline-block';
                    document.getElementById('cancelBtn').style.display = 'inline-block';
                })
                .catch(error => {
                    console.error('Failed to load chat:', error);
                    document.getElementById('chatContainer').innerHTML = 
                        '<div class="alert alert-danger m-3">Failed to load chat</div>';
                });
        }
        
        function loadMessages() {
            fetch(`/api/chat/${currentChatId}/messages`)
                .then(response => response.json())
                .then(messages => {
                    displayMessages(messages);
                })
                .catch(error => {
                    console.error('Failed to load messages:', error);
                });
        }
        
        function displayMessages(messages) {
            const container = document.getElementById('chatContainer');
            let html = '';
            
            messages.forEach(message => {
                const messageClass = getMessageClass(message);
                const time = new Date(message.createdAt).toLocaleTimeString();
                
                if (message.messageType === 'SYSTEM' || message.messageType === 'EXCHANGE_COMPLETED' || message.messageType === 'EXCHANGE_CANCELLED') {
                    html += `
                        <div class="message ${messageClass}">
                            <div>${message.content}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    `;
                } else {
                    const isOwnMessage = message.senderId === currentUserId;
                    const senderName = isOwnMessage ? 'You' : (otherUserName || 'Other User');
                    
                    html += `
                        <div class="message ${messageClass}">
                            <div class="message-sender">${senderName}</div>
                            <div>${message.content}</div>
                            <div class="message-time">${time}</div>
                            <div class="message-status">${isOwnMessage ? 'Sent' : ''}</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        
        function getMessageClass(message) {
            if (message.messageType === 'SYSTEM' || message.messageType === 'EXCHANGE_COMPLETED' || message.messageType === 'EXCHANGE_CANCELLED') {
                return 'system';
            } else if (message.senderId === currentUserId) {
                return 'sent';
            } else {
                return 'received';
            }
        }
        
        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                console.log('Connected to WebSocket');
                document.getElementById('connectionStatus').innerText = 'Connected';
                
                // Subscribe to chat messages
                stompClient.subscribe(`/topic/chat/${currentChatId}`, function (message) {
                    const messageData = JSON.parse(message.body);
                    handleIncomingMessage(messageData);
                });
                
                // Subscribe to typing events
                stompClient.subscribe(`/topic/chat/${currentChatId}/typing`, function (message) {
                    const data = JSON.parse(message.body);
                    if (data.userId !== currentUserId) {
                        showTypingIndicator();
                    }
                });
                
                // Subscribe to stop typing events
                stompClient.subscribe(`/topic/chat/${currentChatId}/stopTyping`, function (message) {
                    const data = JSON.parse(message.body);
                    if (data.userId !== currentUserId) {
                        removeTypingIndicator();
                    }
                });
                
                // Join the chat
                stompClient.send("/app/chat.addUser", {}, JSON.stringify({
                    chatId: currentChatId
                }));
                
                // Enable input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
            }, function (error) {
                console.error('WebSocket connection failed:', error);
                document.getElementById('connectionStatus').innerText = 'Connection failed';
            });
        }
        
        function handleIncomingMessage(messageData) {
            if (messageData.error) {
                console.error('Message error:', messageData.error);
                return;
            }
            
            // Remove typing indicator if it exists
            removeTypingIndicator();
            
            // Add new message to chat
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${getMessageClass(messageData)}`;
            
            const time = new Date(messageData.createdAt).toLocaleTimeString();
            
            if (messageData.messageType === 'SYSTEM' || messageData.messageType === 'EXCHANGE_COMPLETED' || messageData.messageType === 'EXCHANGE_CANCELLED') {
                messageDiv.innerHTML = `
                    <div>${messageData.content}</div>
                    <div class="message-time">${time}</div>
                `;
            } else {
                const isOwnMessage = messageData.senderId === currentUserId;
                const senderName = isOwnMessage ? 'You' : (otherUserName || 'Other User');
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderName}</div>
                    <div>${messageData.content}</div>
                    <div class="message-time">${time}</div>
                    <div class="message-status">${isOwnMessage ? 'Sent' : ''}</div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const existingIndicator = container.querySelector('.typing-indicator');
            
            if (!existingIndicator) {
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.innerHTML = 'Other user is typing...';
                container.appendChild(indicator);
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function removeTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const indicator = container.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        function handleTyping() {
            if (!isTyping) {
                isTyping = true;
                stompClient.send("/app/chat.typing", {}, JSON.stringify({
                    chatId: currentChatId,
                    userId: currentUserId
                }));
            }
            
            // Reset typing timer
            if (typingTimer) {
                clearTimeout(typingTimer);
            }
            
            typingTimer = setTimeout(() => {
                isTyping = false;
                stompClient.send("/app/chat.stopTyping", {}, JSON.stringify({
                    chatId: currentChatId,
                    userId: currentUserId
                }));
            }, 1000);
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !stompClient) {
                return;
            }
            
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({
                chatId: currentChatId,
                content: message
            }));
            
            input.value = '';
        }
        
        function completeExchange() {
            if (!confirm('Are you sure you want to complete this exchange? This will end the chat.')) {
                return;
            }
            
            fetch(`/api/chat/${currentChatId}/complete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Exchange completed successfully!');
                    window.location.href = '/pages/my-received-requests.html';
                }
            })
            .catch(error => {
                console.error('Complete failed:', error);
                alert('Failed to complete exchange. Please try again.');
            });
        }
        
        function cancelExchange() {
            if (!confirm('Are you sure you want to cancel this exchange? This will end the chat.')) {
                return;
            }
            
            fetch(`/api/chat/${currentChatId}/cancel`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Exchange cancelled.');
                    window.location.href = '/pages/my-received-requests.html';
                }
            })
            .catch(error => {
                console.error('Cancel failed:', error);
                alert('Failed to cancel exchange. Please try again.');
            });
        }
        
        // Event listeners
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        document.getElementById('messageInput').addEventListener('input', function() {
            if (stompClient && stompClient.connected) {
                handleTyping();
            }
        });
        </script>
    </body>
</html> 